<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Despux Engineering - Gear Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap');
        
        /* * THEME CONFIGURATION 
         * Default is DARK mode (Professional CAD look)
         */
        :root {
            /* Dark Theme (Default) */
            --bg-body: #0f172a;       /* Slate 900 */
            --bg-panel: #1e293b;      /* Slate 800 */
            --bg-input: #020617;      /* Slate 950 */
            --text-main: #f8fafc;     /* Slate 50 */
            --text-muted: #94a3b8;    /* Slate 400 */
            --border-color: #334155;  /* Slate 700 */
            --brand-primary: #3b82f6; /* Blue 500 */
            --accent-bg: rgba(59, 130, 246, 0.15);
            
            /* Canvas Colors */
            --canvas-bg: #0f172a;
            --canvas-grid: rgba(148, 163, 184, 0.1);
            --gear-fill: #334155;
            --gear-stroke: #f1f5f9;
            --dim-line: #ef4444;
        }

        /* Light Theme Override */
        [data-theme="light"] {
            --bg-body: #f8fafc;       /* Slate 50 */
            --bg-panel: #ffffff;      /* White */
            --bg-input: #f1f5f9;      /* Slate 100 */
            --text-main: #0f172a;     /* Slate 900 */
            --text-muted: #64748b;    /* Slate 500 */
            --border-color: #e2e8f0;  /* Slate 200 */
            --brand-primary: #2563eb; /* Blue 600 */
            --accent-bg: rgba(37, 99, 235, 0.1);

            /* Canvas Colors */
            --canvas-bg: #f8fafc;
            --canvas-grid: rgba(100, 116, 139, 0.15);
            --gear-fill: #cbd5e1;
            --gear-stroke: #1e293b;
            --dim-line: #dc2626;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-body);
            color: var(--text-main);
            transition: background-color 0.3s, color 0.3s;
        }
        
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Technical Grid Pattern */
        .engineering-grid {
            background-size: 40px 40px;
            background-image:
                linear-gradient(to right, var(--canvas-grid) 1px, transparent 1px),
                linear-gradient(to bottom, var(--canvas-grid) 1px, transparent 1px);
        }

        /* Inputs */
        .input-tech {
            transition: all 0.2s;
            border: 1px solid var(--border-color);
            background-color: var(--bg-input);
            color: var(--text-main);
        }
        .input-tech:focus {
            border-color: var(--brand-primary);
            box-shadow: 0 0 0 1px var(--brand-primary);
            outline: none;
        }

        /* Buttons */
        .btn-lang {
            opacity: 0.5;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        .btn-lang:hover { opacity: 0.8; }
        .btn-lang.active { 
            opacity: 1; 
            border-color: var(--brand-primary);
            background-color: var(--accent-bg);
            font-weight: bold;
        }
        
        .btn-unit {
             border: 1px solid var(--border-color);
             color: var(--text-muted);
        }
        .btn-unit.active {
            background-color: var(--brand-primary);
            color: white;
            border-color: var(--brand-primary);
        }

        /* Table Styles */
        .tech-table td { padding: 0.75rem 0; border-bottom: 1px solid var(--border-color); color: var(--text-main); }
        .tech-table th { 
            text-transform: uppercase; 
            font-size: 0.65rem; 
            letter-spacing: 0.05em; 
            color: var(--text-muted); 
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border-color);
        }
        .tech-table tr:last-child td { border-bottom: none; }

        /* Tooltip */
        .tooltip-trigger:hover + .tooltip-content { display: block; }
        .tooltip-content { display: none; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-body); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-sm">

    <!-- Professional Navbar -->
    <header class="h-16 border-b border-[var(--border-color)] bg-[var(--bg-panel)] flex items-center justify-between px-6 shrink-0 z-30 transition-colors duration-300">
        <div class="flex items-center gap-4">
            <!-- Brand Link -->
            <a href="https://www.despux.net" target="_blank" class="flex items-center gap-2 group hover:opacity-90 transition-opacity">
                <div class="w-8 h-8 bg-[var(--brand-primary)] text-white flex items-center justify-center font-bold font-mono rounded-sm group-hover:scale-105 transition-transform">DE</div>
                <div>
                    <h1 class="font-bold text-[var(--text-main)] tracking-tight leading-none">DESPUX</h1>
                    <span class="text-[10px] text-[var(--text-muted)] font-medium tracking-widest uppercase">Engineering</span>
                </div>
            </a>
            <div class="h-6 w-px bg-[var(--border-color)] mx-2"></div>
            <span class="text-xs text-[var(--text-muted)] hidden sm:block" data-i18n="moduleName">Gear Design Module</span>
        </div>
        
        <div class="flex items-center gap-4">
            <!-- Language Switcher -->
            <div class="flex bg-[var(--bg-input)] rounded border border-[var(--border-color)] p-1">
                <button onclick="changeLang('es')" class="btn-lang px-2 py-1 rounded text-xs" id="lang-es">üá™üá∏ ES</button>
                <button onclick="changeLang('en')" class="btn-lang px-2 py-1 rounded text-xs" id="lang-en">üá¨üáß EN</button>
                <button onclick="changeLang('de')" class="btn-lang px-2 py-1 rounded text-xs" id="lang-de">üá©üá™ DE</button>
            </div>

            <!-- Theme Toggle -->
            <button onclick="toggleTheme()" class="w-8 h-8 rounded border border-[var(--border-color)] bg-[var(--bg-input)] text-[var(--text-muted)] hover:text-[var(--text-main)] flex items-center justify-center transition-colors">
                <i class="fa-solid fa-moon" id="themeIcon"></i>
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <!-- Left Panel: Parameters -->
        <aside class="w-80 bg-[var(--bg-panel)] border-r border-[var(--border-color)] flex flex-col shrink-0 z-20 shadow-lg transition-colors duration-300">
            <div class="p-5 border-b border-[var(--border-color)]">
                
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xs font-bold text-[var(--text-muted)] uppercase tracking-wider" data-i18n="geoConfig">Configuraci√≥n</h2>
                    <!-- Units Switch -->
                    <div class="flex gap-1">
                        <button onclick="setUnits('metric')" id="btnMetric" class="btn-unit px-2 py-0.5 rounded text-[10px] font-bold active">ISO (mm)</button>
                        <button onclick="setUnits('imperial')" id="btnImperial" class="btn-unit px-2 py-0.5 rounded text-[10px] font-bold">ANSI (in)</button>
                    </div>
                </div>
                
                <div class="space-y-5">
                    <!-- Toggle Type -->
                    <div class="flex bg-[var(--bg-input)] p-1 rounded-md border border-[var(--border-color)]">
                        <button onclick="setMode('recto')" id="btnRecto" class="flex-1 py-1.5 px-2 rounded text-xs font-semibold text-[var(--text-main)] bg-[var(--bg-panel)] shadow-sm transition-all" data-i18n="spurGear">Recto</button>
                        <button onclick="setMode('helicoidal')" id="btnHelicoidal" class="flex-1 py-1.5 px-2 rounded text-xs font-semibold text-[var(--text-muted)] hover:text-[var(--text-main)] transition-all" data-i18n="helicalGear">Helicoidal</button>
                    </div>

                    <!-- Input Grid -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="col-span-1">
                            <label class="block text-[10px] font-semibold text-[var(--text-muted)] uppercase mb-1.5" id="labelModule" data-i18n="module">M√≥dulo (m)</label>
                            <input type="number" id="inModule" value="3" step="0.25" class="input-tech w-full px-3 py-2 rounded font-mono font-medium">
                        </div>
                        <div class="col-span-1">
                            <label class="block text-[10px] font-semibold text-[var(--text-muted)] uppercase mb-1.5" data-i18n="teeth">Dientes (Z)</label>
                            <input type="number" id="inTeeth" value="28" step="1" class="input-tech w-full px-3 py-2 rounded font-mono font-medium">
                        </div>
                    </div>

                    <!-- Helical Options -->
                    <div id="helicalInputs" class="hidden animate-fade-in">
                        <label class="block text-[10px] font-semibold text-[var(--brand-primary)] uppercase mb-1.5" data-i18n="helixAngle">√Ångulo H√©lice (Œ≤)</label>
                        <div class="relative">
                            <input type="number" id="inHelixAngle" value="15" class="input-tech w-full px-3 py-2 rounded font-mono font-medium border-[var(--brand-primary)]">
                            <span class="absolute right-3 top-2 text-xs text-[var(--brand-primary)] opacity-70">deg</span>
                        </div>
                    </div>

                    <!-- Standards -->
                    <div>
                        <label class="block text-[10px] font-semibold text-[var(--text-muted)] uppercase mb-1.5" data-i18n="depthStd">Norma de Profundidad</label>
                        <div class="relative">
                            <select id="inSystem" class="input-tech w-full px-3 py-2 rounded text-xs appearance-none cursor-pointer">
                                <option value="2.166">Casillas / DIN (2.166)</option>
                                <option value="2.25">ISO / ANSI (2.25)</option>
                            </select>
                            <i class="fa-solid fa-chevron-down absolute right-3 top-2.5 text-[var(--text-muted)] text-[10px] pointer-events-none"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calculated Data Panel -->
            <div class="flex-1 overflow-y-auto p-5">
                <h2 class="text-xs font-bold text-[var(--text-muted)] uppercase tracking-wider mb-4" data-i18n="results">Resultados</h2>
                
                <!-- Main KPI -->
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <div class="p-3 bg-[var(--bg-input)] rounded border border-[var(--border-color)]">
                        <span class="block text-[10px] text-[var(--text-muted)] uppercase mb-1" data-i18n="outerDia">D. Exterior</span>
                        <div class="flex items-baseline gap-1">
                            <span id="outDe" class="block text-lg font-mono font-semibold text-[var(--text-main)]">-</span>
                            <span class="text-[10px] text-[var(--text-muted)] unit-label">mm</span>
                        </div>
                    </div>
                    <div class="p-3 bg-[var(--bg-input)] rounded border border-[var(--border-color)]">
                        <span class="block text-[10px] text-[var(--text-muted)] uppercase mb-1" data-i18n="pitchDia">D. Primitivo</span>
                        <div class="flex items-baseline gap-1">
                            <span id="outDp" class="block text-lg font-mono font-semibold text-[var(--brand-primary)]">-</span>
                            <span class="text-[10px] text-[var(--text-muted)] unit-label">mm</span>
                        </div>
                    </div>
                </div>

                <!-- Technical List -->
                <div class="space-y-4">
                    <div class="flex justify-between items-center border-b border-[var(--border-color)] pb-2">
                        <span class="text-xs text-[var(--text-muted)]" data-i18n="totalDepth">Profundidad Total (h)</span>
                        <span id="outH" class="font-mono font-medium text-[var(--text-main)]">-</span>
                    </div>
                    
                    <!-- Fresa Section Expanded -->
                    <div class="relative border-b border-[var(--border-color)] pb-2">
                        <div class="flex justify-between items-center mb-1">
                            <div class="flex items-center gap-1 group relative">
                                <span class="text-xs text-[var(--text-muted)] cursor-help border-b border-dotted border-[var(--text-muted)]" data-i18n="cutterSet">Juego de Fresas</span>
                                <i class="fa-solid fa-circle-info text-[10px] text-[var(--brand-primary)]"></i>
                                <!-- Tooltip -->
                                <div class="absolute bottom-full left-0 mb-2 w-64 bg-black text-white text-[10px] p-2 rounded shadow-xl hidden group-hover:block z-50 pointer-events-none">
                                    <p class="font-bold mb-1">Sistema Brown & Sharpe</p>
                                    <p>Sistema est√°ndar de 8 fresas de disco para perfiles evolventes de 14.5¬∞/20¬∞. El perfil del diente cambia con el n√∫mero de dientes (flancos m√°s curvos en pi√±ones, m√°s rectos en engranajes grandes).</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <span id="outCutter" class="block font-bold text-[var(--brand-primary)] text-lg">-</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <span id="outRange" class="text-[10px] text-[var(--text-muted)]">-</span>
                        </div>
                        <div class="mt-2 bg-[var(--accent-bg)] p-2 rounded text-[10px] text-[var(--brand-primary)] italic hidden" id="cutterInfoBox">
                            Esta fresa est√° dise√±ada para corregir la interferencia en pi√±ones peque√±os.
                        </div>
                    </div>

                    <div class="flex justify-between items-center border-b border-[var(--border-color)] pb-2">
                        <span class="text-xs text-[var(--text-muted)]" data-i18n="indexing">Divisor (40:1)</span>
                        <span id="outIndexing" class="font-mono font-medium text-[var(--text-main)]">-</span>
                    </div>

                    <div id="helicalResults" class="hidden pt-2">
                        <div class="p-3 bg-[var(--accent-bg)] border border-[var(--brand-primary)] border-opacity-30 rounded text-[var(--brand-primary)] text-xs">
                            <div class="flex justify-between mb-1">
                                <span class="font-medium" data-i18n="lead">Paso H√©lice:</span>
                                <span id="outLead" class="font-mono font-bold">-</span>
                            </div>
                            <div class="flex justify-between opacity-70">
                                <span data-i18n="zVirtual">Z Virtual:</span>
                                <span id="noteZv" class="font-mono">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="p-4 border-t border-[var(--border-color)] text-[10px] text-[var(--text-muted)] text-center">
                ¬© 2024 Despux Engineering
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col min-w-0 bg-[var(--bg-body)] relative transition-colors duration-300">
            
            <!-- Canvas Toolbar -->
            <div class="absolute top-4 right-4 z-10 flex gap-2">
                <div class="bg-[var(--bg-panel)] backdrop-blur border border-[var(--border-color)] shadow-sm rounded px-3 py-1.5 text-xs text-[var(--text-muted)] font-mono">
                    <span id="scaleInfo">Scale: 1:1</span>
                </div>
            </div>

            <!-- CAD Viewport -->
            <div class="flex-1 engineering-grid flex items-center justify-center overflow-hidden">
                <canvas id="mainCanvas" class="max-w-[90%] max-h-[90%]"></canvas>
            </div>

            <!-- Footer Data -->
            <div class="h-48 bg-[var(--bg-panel)] border-t border-[var(--border-color)] shrink-0 flex flex-col transition-colors duration-300">
                <div class="px-6 py-3 border-b border-[var(--border-color)] bg-[var(--bg-input)] flex justify-between items-center">
                    <h3 class="text-xs font-bold text-[var(--text-main)] uppercase" data-i18n="fabSpecs">Especificaciones de Fabricaci√≥n</h3>
                    <div class="text-xs text-[var(--text-muted)]"><i class="fa-regular fa-file-lines mr-1"></i> <span data-i18n="techReport">Reporte T√©cnico</span></div>
                </div>
                
                <div class="flex-1 overflow-auto px-6 py-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                        
                        <!-- Col 1 -->
                        <table class="w-full tech-table text-xs">
                            <thead><tr><th class="text-left" data-i18n="param">Par√°metro</th><th class="text-right"><span data-i18n="value">Valor</span> (<span class="unit-label">mm</span>)</th></tr></thead>
                            <tbody>
                                <tr>
                                    <td data-i18n="circularPitch">Paso Circular</td>
                                    <td class="text-right font-mono" id="tabPc">-</td>
                                </tr>
                                <tr>
                                    <td data-i18n="toothThick">Espesor Diente</td>
                                    <td class="text-right font-mono" id="tabS">-</td>
                                </tr>
                            </tbody>
                        </table>

                        <!-- Col 2 -->
                        <table class="w-full tech-table text-xs">
                            <thead><tr><th class="text-left" data-i18n="geometry">Geometr√≠a</th><th class="text-right"><span data-i18n="value">Valor</span> (<span class="unit-label">mm</span>)</th></tr></thead>
                            <tbody>
                                <tr>
                                    <td data-i18n="addendum">Cabeza (Addendum)</td>
                                    <td class="text-right font-mono" id="tabAdd">-</td>
                                </tr>
                                <tr>
                                    <td data-i18n="dedendum">Pie (Dedendum)</td>
                                    <td class="text-right font-mono" id="tabDed">-</td>
                                </tr>
                            </tbody>
                        </table>

                         <!-- Col 3: Manufacturing Notes -->
                         <div class="col-span-1 lg:col-span-2 bg-[var(--bg-input)] rounded border border-[var(--border-color)] p-3">
                            <h4 class="text-[10px] font-bold text-[var(--text-muted)] uppercase mb-2" data-i18n="processNotes">Notas de Proceso</h4>
                            <p class="text-xs text-[var(--text-muted)] leading-relaxed">
                                <span data-i18n="noteConcentricity">Mantener rigurosa concentricidad. Profundidad total de corte</span> <strong id="noteDepth" class="text-[var(--text-main)]">-</strong> <span class="unit-label">mm</span>.
                                <span id="helicalNote" class="hidden">
                                    <span data-i18n="noteHelical">Configuraci√≥n helicoidal requiere giro de mesa de</span> <strong id="noteAngle">-</strong>¬∞.
                                </span>
                            </p>
                        </div>

                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        // --- TRANSLATION DATA ---
        const i18n = {
            es: {
                moduleName: "M√≥dulo de Dise√±o",
                geoConfig: "Configuraci√≥n",
                spurGear: "Recto",
                helicalGear: "Helicoidal",
                module: "M√≥dulo (m)",
                dp: "Diametral Pitch (DP)",
                teeth: "Dientes (Z)",
                helixAngle: "√Ångulo H√©lice (Œ≤)",
                depthStd: "Norma de Profundidad",
                results: "Resultados",
                outerDia: "D. Exterior",
                pitchDia: "D. Primitivo",
                totalDepth: "Profundidad Total",
                cutterSet: "Juego de Fresas (B&S)",
                indexing: "Divisor (40:1)",
                lead: "Paso H√©lice:",
                zVirtual: "Z Virtual:",
                fabSpecs: "Especificaciones de Fabricaci√≥n",
                techReport: "Reporte T√©cnico",
                param: "Par√°metro",
                value: "Valor",
                circularPitch: "Paso Circular",
                toothThick: "Espesor Diente",
                geometry: "Geometr√≠a",
                addendum: "Cabeza (Addendum)",
                dedendum: "Pie (Dedendum)",
                processNotes: "Notas de Proceso",
                noteConcentricity: "Mantener rigurosa concentricidad. Profundidad total de corte",
                noteHelical: "Configuraci√≥n helicoidal requiere giro de mesa de"
            },
            en: {
                moduleName: "Gear Design Module",
                geoConfig: "Settings",
                spurGear: "Spur",
                helicalGear: "Helical",
                module: "Module (m)",
                dp: "Diametral Pitch (DP)",
                teeth: "Teeth (Z)",
                helixAngle: "Helix Angle (Œ≤)",
                depthStd: "Depth Standard",
                results: "Results",
                outerDia: "Outer Dia.",
                pitchDia: "Pitch Dia.",
                totalDepth: "Total Depth",
                cutterSet: "Cutter Set (B&S)",
                indexing: "Indexing (40:1)",
                lead: "Helix Lead:",
                zVirtual: "Virtual Z:",
                fabSpecs: "Manufacturing Specs",
                techReport: "Tech Report",
                param: "Parameter",
                value: "Value",
                circularPitch: "Circular Pitch",
                toothThick: "Tooth Thickness",
                geometry: "Geometry",
                addendum: "Addendum",
                dedendum: "Dedendum",
                processNotes: "Process Notes",
                noteConcentricity: "Maintain strict concentricity. Total cut depth",
                noteHelical: "Helical setup requires table rotation of"
            },
            de: {
                moduleName: "Zahnrad-Design Modul",
                geoConfig: "Einstellungen",
                spurGear: "Geradverzahnt",
                helicalGear: "Schr√§gverzahnt",
                module: "Modul (m)",
                dp: "Diametral Pitch (DP)",
                teeth: "Z√§hnezahl (Z)",
                helixAngle: "Schr√§gungswinkel (Œ≤)",
                depthStd: "Zahntiefe Norm",
                results: "Ergebnisse",
                outerDia: "Kopfkreisdurchmesser",
                pitchDia: "Teilkreisdurchmesser",
                totalDepth: "Zahntiefe",
                cutterSet: "Fr√§sersatz (B&S)",
                indexing: "Teilkopf (40:1)",
                lead: "Steigung:",
                zVirtual: "Virtuelle Z:",
                fabSpecs: "Fertigungsspezifikationen",
                techReport: "Technischer Bericht",
                param: "Parameter",
                value: "Wert",
                circularPitch: "Teilung",
                toothThick: "Zahndicke",
                geometry: "Geometrie",
                addendum: "Kopfh√∂he",
                dedendum: "Fu√üh√∂he",
                processNotes: "Prozesshinweise",
                noteConcentricity: "Strenge Konzentrizit√§t wahren. Gesamtschnitttiefe",
                noteHelical: "Schr√§gverzahnung erfordert Tischdrehung von"
            }
        };

        // --- STATE & CORE LOGIC ---
        let currentLang = 'es';
        
        const ui = {
            inputs: {
                module: document.getElementById('inModule'),
                teeth: document.getElementById('inTeeth'),
                angle: document.getElementById('inHelixAngle'),
                system: document.getElementById('inSystem'),
                helicalPanel: document.getElementById('helicalInputs'),
                labelModule: document.getElementById('labelModule')
            },
            buttons: {
                recto: document.getElementById('btnRecto'),
                helicoidal: document.getElementById('btnHelicoidal'),
                langs: {
                    es: document.getElementById('lang-es'),
                    en: document.getElementById('lang-en'),
                    de: document.getElementById('lang-de')
                },
                units: {
                    metric: document.getElementById('btnMetric'),
                    imperial: document.getElementById('btnImperial')
                }
            },
            outputs: {
                de: document.getElementById('outDe'),
                dp: document.getElementById('outDp'),
                h: document.getElementById('outH'),
                cutter: document.getElementById('outCutter'),
                range: document.getElementById('outRange'),
                indexing: document.getElementById('outIndexing'),
                lead: document.getElementById('outLead'),
                helicalRes: document.getElementById('helicalResults'),
                tabPc: document.getElementById('tabPc'),
                tabS: document.getElementById('tabS'),
                tabAdd: document.getElementById('tabAdd'),
                tabDed: document.getElementById('tabDed'),
                noteDepth: document.getElementById('noteDepth'),
                helicalNote: document.getElementById('helicalNote'),
                noteAngle: document.getElementById('noteAngle'),
                noteZv: document.getElementById('noteZv'),
                unitLabels: document.querySelectorAll('.unit-label')
            },
            canvas: document.getElementById('mainCanvas')
        };

        let state = {
            mode: 'recto',
            units: 'metric', // 'metric' or 'imperial'
            val: 3, // Holds Module OR DP value depending on unit
            z: 28,
            beta: 15,
            factorH: 2.166
        };

        // Standard Brown & Sharpe Involute Cutter System
        const cutterTable = [
            { id: 1, min: 135, max: 9999, desc: "135 a ‚àû dientes (Cremallera)" },
            { id: 2, min: 55, max: 134, desc: "55 a 134 dientes" },
            { id: 3, min: 35, max: 54, desc: "35 a 54 dientes" },
            { id: 4, min: 26, max: 34, desc: "26 a 34 dientes" },
            { id: 5, min: 21, max: 25, desc: "21 a 25 dientes" },
            { id: 6, min: 17, max: 20, desc: "17 a 20 dientes" },
            { id: 7, min: 14, max: 16, desc: "14 a 16 dientes" },
            { id: 8, min: 12, max: 13, desc: "12 a 13 dientes" }
        ];

        // --- FUNCTIONS ---

        function changeLang(lang) {
            currentLang = lang;
            
            // Update Buttons State
            Object.values(ui.buttons.langs).forEach(btn => btn.classList.remove('active'));
            ui.buttons.langs[lang].classList.add('active');

            // Translate Text Elements
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                // Check if key is 'module' specifically to handle DP toggle logic dynamically instead
                if (key === 'module' && state.units === 'imperial') {
                    el.textContent = i18n[lang]['dp'];
                } else if (i18n[lang][key]) {
                    el.textContent = i18n[lang][key];
                }
            });

            calculate(); 
        }

        function setUnits(unit) {
            state.units = unit;
            
            if (unit === 'metric') {
                ui.buttons.units.metric.classList.add('active');
                ui.buttons.units.imperial.classList.remove('active');
                ui.inputs.labelModule.setAttribute('data-i18n', 'module');
                ui.inputs.labelModule.textContent = i18n[currentLang]['module'];
                
                // Set default workable value if coming from DP
                if (ui.inputs.module.value > 20) ui.inputs.module.value = 3; 
                ui.outputs.unitLabels.forEach(el => el.textContent = 'mm');
            } else {
                ui.buttons.units.metric.classList.remove('active');
                ui.buttons.units.imperial.classList.add('active');
                ui.inputs.labelModule.setAttribute('data-i18n', 'dp');
                ui.inputs.labelModule.textContent = i18n[currentLang]['dp'];
                
                // Set default DP value if coming from Module
                if (ui.inputs.module.value < 4) ui.inputs.module.value = 10;
                ui.outputs.unitLabels.forEach(el => el.textContent = 'in');
            }
            calculate();
        }

        function toggleTheme() {
            const body = document.body;
            const icon = document.getElementById('themeIcon');
            const isLight = body.getAttribute('data-theme') === 'light';
            
            if (isLight) {
                body.removeAttribute('data-theme'); // Go Dark (Default)
                icon.className = 'fa-solid fa-moon';
            } else {
                body.setAttribute('data-theme', 'light');
                icon.className = 'fa-solid fa-sun';
            }
            calculate();
        }

        function setMode(mode) {
            state.mode = mode;
            // Update UI State for Mode Buttons
            const activeClass = ['text-[var(--text-main)]', 'bg-[var(--bg-panel)]', 'shadow-sm'];
            
            if (mode === 'recto') {
                ui.inputs.helicalPanel.classList.add('hidden');
                ui.outputs.helicalRes.classList.add('hidden');
                ui.outputs.helicalNote.classList.add('hidden');
                
                ui.buttons.recto.classList.add(...activeClass);
                ui.buttons.recto.classList.remove('text-[var(--text-muted)]');
                
                ui.buttons.helicoidal.classList.remove(...activeClass);
                ui.buttons.helicoidal.classList.add('text-[var(--text-muted)]');
            } else {
                ui.inputs.helicalPanel.classList.remove('hidden');
                ui.outputs.helicalRes.classList.remove('hidden');
                ui.outputs.helicalNote.classList.remove('hidden');
                
                ui.buttons.helicoidal.classList.add(...activeClass);
                ui.buttons.helicoidal.classList.remove('text-[var(--text-muted)]');
                
                ui.buttons.recto.classList.remove(...activeClass);
                ui.buttons.recto.classList.add('text-[var(--text-muted)]');
            }
            calculate();
        }

        function getCutter(teeth) {
            if (teeth < 12) return { id: "Esp.", desc: "Requiere perfil especial (<12)" };
            for (let c of cutterTable) {
                if (teeth >= c.min && teeth <= c.max) return c;
            }
            return { id: "?", desc: "Fuera de rango est√°ndar" };
        }

        function calculate() {
            state.val = parseFloat(ui.inputs.module.value) || 0;
            state.z = parseInt(ui.inputs.teeth.value) || 0;
            state.beta = parseFloat(ui.inputs.angle.value) || 0;
            state.factorH = parseFloat(ui.inputs.system.value);

            if (state.val <= 0 || state.z <= 0) return;

            let Dp, De, H_total, Addendum, Dedendum, Pc, S, Lead;
            let M_normal_metric; // Necesario para la selecci√≥n de fresa en sistema m√©trico visualmente
            
            let Z_virtual = state.z;
            let helixRad = (state.beta * Math.PI) / 180;

            // --- CALCULATION ENGINE ---
            if (state.units === 'metric') {
                // *** METRIC LOGIC (M) ***
                let M = state.val;
                let Mt = M; // Transverse Module
                
                if (state.mode === 'helicoidal') {
                    Mt = M / Math.cos(helixRad);
                    Z_virtual = state.z / Math.pow(Math.cos(helixRad), 3);
                }

                Dp = Mt * state.z;
                H_total = state.factorH * M;
                Addendum = M;
                Dedendum = H_total - Addendum;
                De = Dp + (2 * M);
                Pc = Math.PI * Mt;
                S = Pc / 2;

                if (state.mode === 'helicoidal' && state.beta > 0) {
                    Lead = Math.PI * Dp * (1 / Math.tan(helixRad));
                } else {
                    Lead = 0;
                }

            } else {
                // *** IMPERIAL LOGIC (Diametral Pitch) ***
                let Pd = state.val; // Normal Diametral Pitch
                let Pdt = Pd; // Transverse DP

                if (state.mode === 'helicoidal') {
                    Pdt = Pd * Math.cos(helixRad); // Transverse DP is SMALLER than Normal DP? No, Pd_transverse = N / D. 
                    // Formulas:
                    // D = N / Pd_transverse
                    // Pd_transverse = Pd_normal * cos(helix)
                    // Wait, Relation is: Module_t = Module_n / cos(beta). 
                    // Since M = 25.4/P, then (1/Pd_t) = (1/Pd_n) / cos(beta) => Pd_t = Pd_n * cos(beta). Correct.
                    Z_virtual = state.z / Math.pow(Math.cos(helixRad), 3);
                }

                Dp = state.z / Pdt;
                Addendum = 1 / Pd;
                // Use factorH roughly analogous. 2.166/DP or 2.25/DP
                H_total = state.factorH / Pd;
                Dedendum = H_total - Addendum;
                De = Dp + (2 / Pd); // OD = D + 2a
                
                Pc = Math.PI / Pdt;
                S = Pc / 2;

                if (state.mode === 'helicoidal' && state.beta > 0) {
                    Lead = Math.PI * Dp * (1 / Math.tan(helixRad));
                } else {
                    Lead = 0;
                }
            }

            // --- RESULTS ---
            const cutter = getCutter(Z_virtual);

            const turns = Math.floor(40 / state.z);
            const remainder = (40 / state.z) - turns;
            let indexingText = `40/${state.z}`;
            const txtTurns = { es: "vts", en: "turns", de: "Umdr" };
            
            if (remainder === 0) {
                indexingText = `${turns} ${txtTurns[currentLang]}`;
            } else {
                indexingText = `${turns} + ${(remainder).toFixed(3)}`;
            }

            // Formatting
            const dec = state.units === 'metric' ? 2 : 4; // More precision for inches
            const unitSuffix = state.units === 'metric' ? ' mm' : ' in';

            ui.outputs.dp.textContent = Dp.toFixed(dec);
            ui.outputs.de.textContent = De.toFixed(dec);
            ui.outputs.h.textContent = H_total.toFixed(dec + 1) + unitSuffix;
            
            ui.outputs.cutter.textContent = "#" + cutter.id;
            ui.outputs.range.textContent = cutter.desc;
            
            ui.outputs.indexing.textContent = indexingText;
            
            ui.outputs.tabPc.textContent = Pc.toFixed(dec+1);
            ui.outputs.tabS.textContent = S.toFixed(dec+1);
            ui.outputs.tabAdd.textContent = Addendum.toFixed(dec+1);
            ui.outputs.tabDed.textContent = Dedendum.toFixed(dec+1);
            ui.outputs.noteDepth.textContent = H_total.toFixed(dec+1);

            if (state.mode === 'helicoidal') {
                ui.outputs.lead.textContent = Lead.toFixed(dec) + unitSuffix;
                ui.outputs.noteAngle.textContent = state.beta;
                ui.outputs.noteZv.textContent = Z_virtual.toFixed(1);
            }

            drawGear(Dp, De, Dedendum, state.z);
        }

        function drawGear(Dp, De, Dedendum, Z) {
            const canvas = ui.canvas;
            const ctx = canvas.getContext('2d');
            
            const style = getComputedStyle(document.body);
            const colStroke = style.getPropertyValue('--gear-stroke').trim();
            const colFill = style.getPropertyValue('--gear-fill').trim();
            const colDim = style.getPropertyValue('--dim-line').trim();
            const colPrimary = style.getPropertyValue('--brand-primary').trim();
            
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);

            const cx = rect.width / 2;
            const cy = rect.height / 2;

            ctx.clearRect(0, 0, rect.width, rect.height);

            // Scale Logic
            // Scale doesn't care about units, just relative sizes
            const scale = (Math.min(rect.width, rect.height) * 0.4) / (De / 2);
            document.getElementById('scaleInfo').textContent = `Zoom: ${(scale).toFixed(2)}x`;

            const rP = (Dp / 2) * scale;
            const rE = (De / 2) * scale;
            const rI = rP - (Dedendum * scale);

            // 1. Crosshair
            ctx.beginPath();
            ctx.strokeStyle = colDim;
            ctx.lineWidth = 1;
            const markSize = 10;
            ctx.moveTo(cx - markSize, cy); ctx.lineTo(cx + markSize, cy);
            ctx.moveTo(cx, cy - markSize); ctx.lineTo(cx, cy + markSize);
            ctx.stroke();

            // 2. Pitch Circle (Dashed)
            ctx.beginPath();
            ctx.strokeStyle = colPrimary;
            ctx.setLineDash([10, 5]);
            ctx.lineWidth = 1;
            ctx.arc(cx, cy, rP, 0, Math.PI * 2);
            ctx.stroke();
            ctx.setLineDash([]);

            // 3. Gear Profile
            ctx.beginPath();
            ctx.fillStyle = colFill;
            ctx.lineWidth = 1.5;
            ctx.strokeStyle = colStroke;

            const step = (Math.PI * 2) / Z;
            
            for (let i = 0; i < Z; i++) {
                const angle = i * step;
                const toothAng = step * 0.5;
                
                const a1 = angle - toothAng * 0.6;
                const a2 = angle - toothAng * 0.3;
                const a3 = angle + toothAng * 0.3;
                const a4 = angle + toothAng * 0.6;

                ctx.arc(cx, cy, rI, angle - step/2, a1); 
                ctx.lineTo(cx + Math.cos(a2) * rE, cy + Math.sin(a2) * rE);
                ctx.arc(cx, cy, rE, a2, a3);
                ctx.lineTo(cx + Math.cos(a4) * rI, cy + Math.sin(a4) * rI);
            }
            ctx.closePath();
            ctx.fill();
            ctx.stroke();

            // 4. Shaft Hole
            ctx.beginPath();
            ctx.fillStyle = style.getPropertyValue('--bg-body').trim(); 
            ctx.strokeStyle = colStroke;
            ctx.lineWidth = 1.5;
            const rShaft = rP * 0.25;
            ctx.arc(cx, cy, rShaft, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // 5. Keyway
            const kw = rShaft * 0.3;
            const kh = rShaft * 0.3;
            ctx.beginPath();
            ctx.fillStyle = style.getPropertyValue('--bg-body').trim();
            ctx.rect(cx - kw/2, cy - rShaft - kh/2, kw, kh);
            ctx.fill();
            
            // Clean intersection
            ctx.beginPath();
            ctx.strokeStyle = style.getPropertyValue('--bg-body').trim();
            ctx.lineWidth = 3;
            ctx.moveTo(cx - kw/2 + 2, cy - rShaft);
            ctx.lineTo(cx + kw/2 - 2, cy - rShaft);
            ctx.stroke();
            
            // Redraw Keyway Border
            ctx.beginPath();
            ctx.lineWidth = 1.5;
            ctx.strokeStyle = colStroke;
            ctx.moveTo(cx - kw/2, cy - rShaft + 1);
            ctx.lineTo(cx - kw/2, cy - rShaft - kh);
            ctx.lineTo(cx + kw/2, cy - rShaft - kh);
            ctx.lineTo(cx + kw/2, cy - rShaft + 1);
            ctx.stroke();
        }

        // Init
        ui.inputs.module.addEventListener('input', calculate);
        ui.inputs.teeth.addEventListener('input', calculate);
        ui.inputs.angle.addEventListener('input', calculate);
        ui.inputs.system.addEventListener('change', calculate);

        new ResizeObserver(calculate).observe(ui.canvas.parentElement);
        
        // Start Up
        changeLang('es');
        // Defaults to metric visually
    </script>
</body>
</html>
